<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Sample</title>
  <script src="config.js"></script>
  <script>
    function showValidationErrors(data) {
      var messages = {
        required: '<strong>{{Field}}</strong> is required.',
        too_long: '<strong>{{Field}}</strong> is too long.',
        too_short: '<strong>{{Field}}</strong> is too short.',
        email: 'Please enter a correct <strong>email address</strong>.',
      };
      var fieldLabels = {
        name: 'name',
        email: 'email',
        title: 'title',
        message: 'message'
      };

      var errors = data.errors;
      var html = '<ul>';
      errors.forEach(function(error, i) {
        var msg = messages[error.type];
        if (!msg) {
          msg = error.type;
        }
        var label = fieldLabels[error.field];
        msg = msg.replace(/\{\{field\}\}/, label);
        msg = msg.replace(/\{\{Field\}\}/, label.charAt(0).toUpperCase() + label.slice(1));
        html += '<li>' + msg + '</li>';
      });
      html += '</ul>';

      updateErrorHTML(html);
      switchView('fields');
    }
    function showSystemError() {
      updateErrorHTML('<ul><li>System error</li></ul>');
      switchView('fields');
    }
    function showNetworkError() {
      updateErrorHTML('<ul><li>Network error</li></ul>');
      switchView('fields');
    }

    function switchView(name) {
      var names = ['loading', 'fields', 'confirm', 'complete'];
      names.forEach(function(n, i) {
        if (n == name) {
          document.getElementById(n).style.display = '';
        } else {
          document.getElementById(n).style.display = 'none';
        }
      });
    }

    function updateFieldValues(params) {
      var fields = document.querySelectorAll('.field');
      Array.prototype.forEach.call(fields, function(f, i) {
        f.value = params[f.name];
        var cf = document.getElementById('confirm-' + f.name);
        if (cf) {
          cf.textContent = params[f.name];
        }
      });
    }

    function fieldValues() {
      var fields = document.querySelectorAll('.field');
      var values = {};
      Array.prototype.forEach.call(fields, function(f, i) {
        values[f.name] = f.value;
      });
      return values;
    }

    function parseJSON(json) {
      try {
        return JSON.parse(json);
      } catch(e) {
        console.log(e);
        return null;
      }
    }

    function updateErrorHTML(html) {
      var e = document.getElementById('errors');
      e.innerHTML = html;
    }

    function apiRequest(action) {
      var data = fieldValues();
      data.action = action;

      var request = new XMLHttpRequest();
      request.open(apiMethod, apiURL, true);

      // Content-Type requires CORS.
      // request.setRequestHeader('Content-Type', 'application/json');

      request.onload = function() {
        var result = parseJSON(this.response);
        console.log(result);
        if (!result.data) {
          showSystemError();
          return;
        }
        if (result.statusCode == 200) {
          updateErrorHTML('');
          if (action == 'validate') {
            updateFieldValues(result.data.params);
            switchView('confirm');
          } else {
            switchView('complete');
          }
          return;
        }
        if (result.status == 'validation_error') {
          updateFieldValues(result.data.params);
          showValidationErrors(result.data);
          return;
        }
        showSystemError();
      };
      request.onerror = function() {
        showNetworkError();
      };

      request.send(JSON.stringify(data));
    }

    function init() {
      var confirmButton = document.getElementById('fields-confirm');
      confirmButton.addEventListener('click', function(event) {
        event.preventDefault();
        switchView('loading');
        apiRequest('validate');
      });

      var editButton = document.getElementById('confirm-edit');
      editButton.addEventListener('click', function(event) {
        event.preventDefault();
        switchView('fields');
      })

      var sendButton = document.getElementById('confirm-send');
      sendButton.addEventListener('click', function(event) {
        event.preventDefault();
        switchView('loading');
        apiRequest('send');
      })
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</head>

<body>
  <div id="loading" style="display:none">
    <p>Loading...</p>
  </div>
  <div id="fields">
    <h1>Sample Form</h1>
    <div id="errors"></div>
    <form id="fields-form" method="post" action="/post">
      <dl>
      <dt><label for="field-name">Name</label></dt>
      <dd><input type="text" name="name" value="" size="40" class="field" id="field-name"></dd>
      <dt><label for="field-email">Email</label></dt>
      <dd><input type="text" name="email" value="" size="40" class="field" id="field-email"></dd>
      <dt><label for="field-title">Title</label></dt>
      <dd><input type="text" name="title" value="" size="40" class="field" id="field-title" ></dd>
      <dt><label for="field-message">Message</label></dt>
      <dd><textarea name="message" rows="10" cols="60" class="field" id="field-message"></textarea></dd>
      </dl>
      <button id="fields-confirm">Confirm</button>
    </form>
  </div>

  <div id="confirm" style="display:none">
    <dl>
      <dt>Name</dt>
      <dd id="confirm-name"></dd>
      <dt>Email</dt>
      <dd id="confirm-email"></dd>
      <dt>Title</dt>
      <dd id="confirm-title"></dd>
      <dt>Message</dt>
      <dd id="confirm-message" style="white-space:pre"></dd>
    </dl>
    <button id="confirm-edit">Edit</button>
    <button id="confirm-send">Send</button>
  </div>

  <div id="complete" style="display:none">
    Thank you!
  </div>
</body>
</html>
